<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Yard Walk Web App</title>
    <script src="https://unpkg.com/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="Styles.css" />
  </head>
  <body>
    <div id="loading-overlay">
      <div class="loader"></div>
    </div>

    <div class="container">
      <h1 class="title">Yard Walk</h1>

      <div id="error-message"></div>

      <button id="open-camera" class="open-camera-button">Open Camera</button>
      <input
        type="file"
        id="camera-input"
        accept="image/*;capture=camera"
        capture="environment"
        style="display: none"
      />

      <div class="input-group">
        <label for="trailer-number" class="input-label">Trailer Number</label>
        <input
          type="number"
          id="trailer-number"
          class="input-field"
          placeholder="Enter Trailer Number"
        />
      </div>

      <button id="add-comment-button" class="button add-comment-button">
        Add Comment
      </button>

      <div id="comment-container" class="input-group hidden">
        <label for="comments" class="input-label">Comments</label>
        <textarea
          id="comments"
          class="input-field textarea-field"
          rows="3"
          placeholder="Add comments here..."
        ></textarea>
      </div>

      <div class="input-group">
        <div class="radio-button-group">
          <div class="radio-wrapper">
            <input
              class="input"
              type="radio"
              id="value-1"
              checked=""
              name="status"
              value="Empty"
            />
            <div class="btn">
              <span>Empty</span>
              <span class="btn__glitch">Empty</span>
            </div>
          </div>
          <div class="radio-wrapper">
            <input
              class="input"
              type="radio"
              id="value-2"
              name="status"
              value="Salvage"
            />
            <div class="btn">
              <span>Salvage</span>
              <span class="btn__glitch">Salvage</span>
            </div>
          </div>
          <div class="radio-wrapper">
            <input
              class="input"
              type="radio"
              id="value-3"
              name="status"
              value="Full"
            />
            <div class="btn">
              <span>Full</span>
              <span class="btn__glitch">Full</span>
            </div>
          </div>
        </div>
      </div>

      <div class="input-group">
        <div class="checkbox-group">
          <div class="checkbox-container">
            <input
              class="holo-checkbox-input"
              id="needs-fuel"
              type="checkbox"
            />
            <label class="holo-checkbox" for="needs-fuel">
              <div class="holo-box">
                <div class="holo-inner"></div>
                <div class="scan-effect"></div>
                <div class="holo-particles">
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                </div>
                <div class="activation-rings">
                  <div class="activation-ring"></div>
                  <div class="activation-ring"></div>
                  <div class="activation-ring"></div>
                </div>
                <div class="cube-transform">
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                </div>
              </div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="holo-glow"></div>
            </label>
            <div class="status-text">Needs Fuel?</div>
          </div>
          <div class="checkbox-container">
            <input
              class="holo-checkbox-input"
              id="red-tagged"
              type="checkbox"
            />
            <label class="holo-checkbox" for="red-tagged">
              <div class="holo-box">
                <div class="holo-inner"></div>
                <div class="scan-effect"></div>
                <div class="holo-particles">
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                </div>
                <div class="activation-rings">
                  <div class="activation-ring"></div>
                  <div class="activation-ring"></div>
                  <div class="activation-ring"></div>
                </div>
                <div class="cube-transform">
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                </div>
              </div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="holo-glow"></div>
            </label>
            <div class="status-text">Inbound?</div>
          </div>
          <div class="checkbox-container">
            <input class="holo-checkbox-input" id="seasonal" type="checkbox" />
            <label class="holo-checkbox" for="seasonal">
              <div class="holo-box">
                <div class="holo-inner"></div>
                <div class="scan-effect"></div>
                <div class="holo-particles">
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                </div>
                <div class="activation-rings">
                  <div class="activation-ring"></div>
                  <div class="activation-ring"></div>
                  <div class="activation-ring"></div>
                </div>
                <div class="cube-transform">
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                </div>
              </div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="holo-glow"></div>
            </label>
            <div class="status-text">Seasonal?</div>
          </div>
          <div class="checkbox-container">
            <input
              class="holo-checkbox-input"
              id="pallet-shuttle"
              type="checkbox"
            />
            <label class="holo-checkbox" for="pallet-shuttle">
              <div class="holo-box">
                <div class="holo-inner"></div>
                <div class="scan-effect"></div>
                <div class="holo-particles">
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                  <div class="holo-particle"></div>
                </div>
                <div class="activation-rings">
                  <div class="activation-ring"></div>
                  <div class="activation-ring"></div>
                  <div class="activation-ring"></div>
                </div>
                <div class="cube-transform">
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                  <div class="cube-face"></div>
                </div>
              </div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="corner-accent"></div>
              <div class="holo-glow"></div>
            </label>
            <div class="status-text">Pallet Shuttle?</div>
          </div>
        </div>
      </div>

      <div class="input-group">
        <label for="north-fence-line" class="input-label"
          >North Fence Line</label
        >
        <select id="north-fence-line" class="input-field">
          <option value="None">None</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
          <option value="16">16</option>
          <option value="17">17</option>
          <option value="18">18</option>
          <option value="19">19</option>
          <option value="20">20</option>
          <option value="21">21</option>
          <option value="22">22</option>
          <option value="23">23</option>
          <option value="24">24</option>
          <option value="25">25</option>
          <option value="26">26</option>
          <option value="27">27</option>
          <option value="28">28</option>
          <option value="29">29</option>
          <option value="30">30</option>
          <option value="31">31</option>
          <option value="32">32</option>
          <option value="33">33</option>
          <option value="34">34</option>
          <option value="35">35</option>
          <option value="36">36</option>
          <option value="37">37</option>
          <option value="38">38</option>
          <option value="39">39</option>
          <option value="40">40</option>
          <option value="41">41</option>
          <option value="42">42</option>
          <option value="43">43</option>
          <option value="44">44</option>
          <option value="45">45</option>
          <option value="46">46</option>
          <option value="47">47</option>
          <option value="48">48</option>
          <option value="49">49</option>
          <option value="50">50</option>
          <option value="51">51</option>
          <option value="52">52</option>
          <option value="53">53</option>
          <option value="54">54</option>
          <option value="55">55</option>
          <option value="56">56</option>
          <option value="B 1">B-NF 1</option>
          <option value="B 2">B-NF 2</option>
          <option value="WT 1">WT 1</option>
          <option value="WT 2">WT 2</option>
          <option value="WT 3">WT 3</option>
          <option value="WT 4">WT 4</option>
          <option value="WT 5">WT 5</option>
          <option value="TA 1">TA 1</option>
          <option value="TA 2">TA 2</option>
          <option value="TA 3">TA 3</option>
          <option value="TA 4">TA 4</option>
          <option value="TA 5">TA 5</option>
          <option value="TA 6">TA 6</option>
          <option value="Curb 1">Curb 1</option>
          <option value="Curb 2">Curb 2</option>
          <option value="Curb 3">Curb 3</option>
          <option value="Curb 4">Curb 4</option>
          <option value="Curb 5">Curb 5</option>
          <option value="Curb 6">Curb 6</option>
          <option value="NP 1">NP-NF 1</option>
          <option value="NP 2">NP-NF 2</option>
        </select>
      </div>

      <div class="input-group">
        <label for="south-fence-line" class="input-label"
          >South Fence Line</label
        >
        <select id="south-fence-line" class="input-field">
          <option value="None">None</option>
          <option value="301">301</option>
          <option value="302">302</option>
          <option value="303">303</option>
          <option value="304">304</option>
          <option value="305">305</option>
          <option value="306">306</option>
          <option value="307">307</option>
          <option value="308">308</option>
          <option value="309">309</option>
          <option value="310">310</option>
          <option value="311">311</option>
          <option value="312">312</option>
          <option value="313">313</option>
          <option value="314">314</option>
          <option value="315">315</option>
          <option value="316">316</option>
          <option value="317">317</option>
          <option value="318">318</option>
          <option value="319">319</option>
          <option value="320">320</option>
          <option value="321">321</option>
          <option value="322">322</option>
          <option value="323">323</option>
          <option value="324">324</option>
          <option value="325">325</option>
          <option value="326">326</option>
          <option value="327">327</option>
          <option value="328">328</option>
          <option value="329">329</option>
          <option value="330">330</option>
          <option value="331">331</option>
          <option value="332">332</option>
          <option value="333">333</option>
          <option value="334">334</option>
          <option value="335">335</option>
          <option value="336">336</option>
          <option value="337">337</option>
          <option value="338">338</option>
          <option value="339">339</option>
          <option value="340">340</option>
          <option value="341">341</option>
          <option value="342">342</option>
          <option value="343">343</option>
          <option value="344">344</option>
          <option value="345">345</option>
          <option value="346">346</option>
          <option value="347">347</option>
          <option value="348">348</option>
          <option value="349">349</option>
          <option value="350">350</option>
          <option value="351">351</option>
          <option value="352">352</option>
          <option value="353">353</option>
          <option value="354">354</option>
          <option value="355">355</option>
          <option value="356">356</option>
          <option value="357">357</option>
          <option value="358">358</option>
          <option value="359">359</option>
          <option value="360">360</option>
          <option value="361">361</option>
          <option value="362">362</option>
          <option value="363">363</option>
          <option value="364">364</option>
          <option value="365">365</option>
          <option value="366">366</option>
          <option value="367">367</option>
          <option value="368">368</option>
          <option value="369">369</option>
          <option value="370">370</option>
          <option value="371">371</option>
          <option value="372">372</option>
          <option value="373">373</option>
          <option value="374">374</option>
          <option value="375">375</option>
          <option value="376">376</option>
          <option value="377">377</option>
          <option value="378">378</option>
          <option value="379">379</option>
          <option value="380">380</option>
          <option value="381">381</option>
          <option value="382">382</option>
          <option value="383">383</option>
          <option value="384">384</option>
          <option value="385">385</option>
          <option value="386">386</option>
          <option value="387">387</option>
          <option value="388">388</option>
          <option value="389">389</option>
          <option value="390">390</option>
          <option value="391">391</option>
          <option value="392">392</option>
          <option value="393">393</option>
          <option value="394">394</option>
          <option value="395">395</option>
          <option value="396">396</option>
          <option value="397">397</option>
          <option value="398">398</option>
          <option value="399">399</option>
          <option value="NPs 1">NP-SF 1</option>
          <option value="NPs 2">NP-SF 2</option>
          <option value="NPs 3">NP-SF 3</option>
          <option value="Bs 1">B-SF 1</option>
          <option value="Bs 2">B-SF 2</option>
          <option value="Bs 3">B-SF 3</option>
          <option value="Bs 4">B-SF 4</option>
          <option value="Bs 5">B-SF 5</option>
          <option value="Bs 6">B-SF 6</option>
          <option value="Bs 7">B-SF 7</option>
          <option value="Bs 8">B-SF 8</option>
          <option value="Bs 9">B-SF 9</option>
          <option value="Bs 10">B-SF 10</option>
          <option value="Bs 11">B-SF 11</option>
          <option value="Bs 12">B-SF 12</option>
          <option value="Bs 13">B-SF 13</option>
        </select>
      </div>

      <button id="add-trailer" class="button">Enter</button>

      <div class="counts">
        <div id="empty-count" class="text-lg font-semibold">Empty: 0</div>
        <div id="salvage-count" class="text-lg font-semibold">Salvage: 0</div>
        <div id="full-count" class="text-lg font-semibold">Full: 0</div>
      </div>

      <div id="last-entered-window" class="last-entered-window"></div>
      <canvas id="ocr-canvas" style="display: none"></canvas>
    </div>

    <div class="container mt-8">
      <h1 class="title">Entered Trailers</h1>
      <div class="flex items-center justify-between mb-4">
        <h2 class="section-title">Trailers Needing Fuel</h2>
        <span class="needs-fuel-count"
          >Total: <span id="needs-fuel-count">0</span></span
        >
      </div>
      <div class="trailer-list-container">
        <ul id="needs-fuel-list" class="mb-8"></ul>
      </div>

      <h2 class="section-title">All Salvage Trailers</h2>
      <div class="trailer-list-container">
        <ul id="all-salvage-trailers-list"></ul>
      </div>

      <h2 class="section-title">All Empty Trailers</h2>
      <div class="trailer-list-container">
        <ul id="all-empty-trailers-list"></ul>
      </div>

      <h2 class="section-title">All Pallet Shuttle Trailers</h2>
      <div class="trailer-list-container">
        <ul id="all-pallet-shuttle-trailers-list"></ul>
      </div>

      <h2 class="section-title">All Seasonal Trailers</h2>
      <div class="trailer-list-container">
        <ul id="all-seasonal-trailers-list"></ul>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithCustomToken,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        deleteDoc,
        onSnapshot,
        collection,
        setDoc,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import {
        getFunctions,
        httpsCallable,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;
      const envFirebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : null;

      const firebaseConfig = envFirebaseConfig || {
        apiKey: "AIzaSyAxHIhsDl7uR2lmcmj9EWy8epX-1uBmrsw",
        authDomain: "yard-walk.firebaseapp.com",
        projectId: "yard-walk",
        storageBucket: "yard-walk.firebasestorage.app",
        messagingSenderId: "633967680523",
        appId: "1:633967680523:web:47f7148b4966a6642e7b0e",
        measurementId: "G-53CN6Q20PF",
      };

      let db;
      let auth;
      let trailersCollectionRef;
      let isAuthenticated = false;
      let editingDocId = null;

      const setUIState = (state) => {
        const addTrailerButton = document.getElementById("add-trailer");
        const openCameraButton = document.getElementById("open-camera");
        const loadingOverlay = document.getElementById("loading-overlay");
        addTrailerButton.disabled = state === "disabled";
        openCameraButton.disabled = state === "disabled";
        addTrailerButton.classList.toggle("disabled", state === "disabled");
        openCameraButton.classList.toggle("disabled", state === "disabled");
        loadingOverlay.style.display = state === "loading" ? "flex" : "none";
      };

      const displayError = (message) => {
        const errorMessageDiv = document.getElementById("error-message");
        errorMessageDiv.style.display = "block";
        errorMessageDiv.textContent = message;
      };

      const hideError = () => {
        const errorMessageDiv = document.getElementById("error-message");
        errorMessageDiv.style.display = "none";
      };

      const resetForm = () => {
        document.getElementById("trailer-number").value = "";
        document.querySelector(
          'input[name="status"][value="Empty"]'
        ).checked = true;
        document.getElementById("needs-fuel").checked = false;
        document.getElementById("red-tagged").checked = false;
        document.getElementById("seasonal").checked = false;
        document.getElementById("pallet-shuttle").checked = false;
        document.getElementById("north-fence-line").value = "None";
        document.getElementById("south-fence-line").value = "None";
        document.getElementById("comment-container").classList.add("hidden");
        document.getElementById("comments").value = "";
        document.getElementById("add-trailer").textContent = "Enter";
        editingDocId = null;
        document
          .querySelectorAll(".trailer-item")
          .forEach((item) => item.classList.remove("editing"));
      };

      const getSortableValue = (trailerData) => {
        const nf = trailerData.northFence;
        const sf = trailerData.southFence;
        const fenceLine = nf !== "None" ? nf : sf;

        if (fenceLine === "None") {
          return [false, "", 0];
        }

        const parts = fenceLine.split(" ");
        if (parts.length === 1 && !isNaN(parts[0])) {
          return [true, "NF", parseInt(parts[0], 10)];
        }

        const numericPart = parts.pop();
        const prefix = parts.join(" ");

        return [true, prefix, parseInt(numericPart, 10)];
      };

      document.addEventListener("DOMContentLoaded", async () => {
        const trailerNumberInput = document.getElementById("trailer-number");
        const needsFuelCheckbox = document.getElementById("needs-fuel");
        const redTaggedCheckbox = document.getElementById("red-tagged");
        const seasonalCheckbox = document.getElementById("seasonal");
        const palletShuttleCheckbox = document.getElementById("pallet-shuttle");
        const northFenceSelect = document.getElementById("north-fence-line");
        const southFenceSelect = document.getElementById("south-fence-line");
        const commentsTextarea = document.getElementById("comments");
        const addTrailerButton = document.getElementById("add-trailer");
        const lastEnteredWindow = document.getElementById(
          "last-entered-window"
        );
        const emptyCountSpan = document.getElementById("empty-count");
        const salvageCountSpan = document.getElementById("salvage-count");
        const fullCountSpan = document.getElementById("full-count");
        const needsFuelCountSpan = document.getElementById("needs-fuel-count");
        const allEmptyTrailersList = document.getElementById(
          "all-empty-trailers-list"
        );
        const allSalvageTrailersList = document.getElementById(
          "all-salvage-trailers-list"
        );
        const allPalletShuttleTrailersList = document.getElementById(
          "all-pallet-shuttle-trailers-list"
        );
        const allSeasonalTrailersList = document.getElementById(
          "all-seasonal-trailers-list"
        );
        const needsFuelList = document.getElementById("needs-fuel-list");
        const openCameraButton = document.getElementById("open-camera");
        const addCommentButton = document.getElementById("add-comment-button");
        const commentContainer = document.getElementById("comment-container");

        // Use a click event listener for the button
        addCommentButton.addEventListener("click", () => {
          commentContainer.classList.toggle("hidden");
        });

        try {
          setUIState("loading");

          const app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);

          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }
          isAuthenticated = true;
          setUIState("enabled");

          trailersCollectionRef = collection(
            db,
            `artifacts/${appId}/public/data/trailers`
          );

          const cameraInput = document.getElementById("camera-input");
          const ocrCanvas = document.getElementById("ocr-canvas");
          const ocrContext = ocrCanvas.getContext("2d");

          // Function to preprocess image for OCR
          const preprocessImage = (imageBitmap) => {
            ocrCanvas.width = imageBitmap.width;
            ocrCanvas.height = imageBitmap.height;
            ocrContext.drawImage(imageBitmap, 0, 0);

            // Example preprocessing: convert to grayscale
            const imageData = ocrContext.getImageData(
              0,
              0,
              ocrCanvas.width,
              ocrCanvas.height
            );
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
              const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
              data[i] = avg; // red
              data[i + 1] = avg; // green
              data[i + 2] = avg; // blue
            }
            ocrContext.putImageData(imageData, 0, 0);

            return ocrCanvas.toDataURL();
          };

          if (openCameraButton) {
            openCameraButton.addEventListener("click", () => {
              cameraInput.click(); // Trigger the hidden file input
            });
          }

          cameraInput.addEventListener("change", async (event) => {
            const file = event.target.files[0];
            if (!file) {
              return;
            }

            setUIState("loading");
            hideError();

            try {
              const imageBitmap = await createImageBitmap(file);
              const processedImage = preprocessImage(imageBitmap);

              const {
                data: { text },
              } = await Tesseract.recognize(processedImage, "eng", {
                logger: (m) => console.log(m),
              });

              console.log("OCR Result Text:", text); // Debugging output

              const sixDigitNumberMatch = text.match(/\d{6}/);
              if (sixDigitNumberMatch && sixDigitNumberMatch[0].length === 6) {
                trailerNumberInput.value = sixDigitNumberMatch[0];
                hideError();
              } else {
                displayError("No 6-digit trailer number found in the image.");
              }
            } catch (error) {
              console.error("OCR Error:", error);
              displayError("Failed to process image with OCR.");
            } finally {
              setUIState("enabled");
              cameraInput.value = ""; // Clear the input so change event fires again for same file
            }
          });

          trailerNumberInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
              event.preventDefault();
              addTrailerButton.click();
            }
          });

          onSnapshot(
            query(trailersCollectionRef),
            (snapshot) => {
              allEmptyTrailersList.innerHTML = "";
              allSalvageTrailersList.innerHTML = "";
              allPalletShuttleTrailersList.innerHTML = "";
              allSeasonalTrailersList.innerHTML = "";
              needsFuelList.innerHTML = "";
              let emptyCount = 0;
              let salvageCount = 0;
              let fullCount = 0;
              let needsFuelCount = 0;
              let allTrailers = {};

              const tenHoursAgo = new Date(Date.now() - 10 * 60 * 60 * 1000);

              snapshot.forEach((doc) => {
                const trailerData = doc.data();
                if (
                  trailerData.timestamp &&
                  trailerData.timestamp.toDate() < tenHoursAgo
                ) {
                  return;
                }
                allTrailers[doc.id] = trailerData;
              });

              const trailers = Object.keys(allTrailers).map((id) => ({
                id,
                data: allTrailers[id],
              }));

              // Sort trailers by parking spot
              trailers.sort((a, b) => {
                const [isAssignedA, prefixA, numA] = getSortableValue(a.data);
                const [isAssignedB, prefixB, numB] = getSortableValue(b.data);

                if (isAssignedA !== isAssignedB) {
                  return isAssignedB - isAssignedA;
                }
                if (prefixA !== prefixB) {
                  return prefixA.localeCompare(prefixB);
                }
                return numA - numB;
              });

              trailers.forEach((trailer) => {
                const trailerData = trailer.data;
                const docId = trailer.id;

                const details = [
                  trailerData.status,
                  trailerData.needsFuel ? "Needs Fuel" : null,
                  trailerData.redTagged ? "Red Tagged" : null,
                  trailerData.seasonal ? "Seasonal" : null,
                  trailerData.palletShuttle ? "Pallet Shuttle" : null,
                  trailerData.northFence !== "None"
                    ? `NF: ${trailerData.northFence}`
                    : null,
                  trailerData.southFence !== "None"
                    ? `SF: ${trailerData.southFence}`
                    : null,
                  trailerData.comments
                    ? `Comments: ${trailerData.comments}`
                    : null,
                ]
                  .filter(Boolean)
                  .join(", ");

                const createListItem = (docId, trailerData, details) => {
                  const listItem = document.createElement("li");
                  listItem.className = `trailer-item ${
                    docId === editingDocId ? "editing" : ""
                  }`;
                  listItem.dataset.docId = docId;
                  listItem.dataset.trailerNumber = trailerData.trailerNumber;
                  listItem.innerHTML = `
                            <div class="trailer-info">
                                <div class="trailer-number">${trailerData.trailerNumber}</div>
                                <div class="text-sm text-gray-400">${details}</div>
                            </div>
                            <div>
                                <button class="edit-button" data-doc-id="${docId}">
                                    &#9998;
                                </button>
                                <button class="delete-button" data-doc-id="${docId}">
                                    &times;
                                </button>
                            </div>
                        `;
                  return listItem;
                };

                if (trailerData.palletShuttle) {
                  const palletShuttleItem = createListItem(
                    docId,
                    trailerData,
                    details
                  );
                  allPalletShuttleTrailersList.appendChild(palletShuttleItem);
                }

                if (trailerData.seasonal) {
                  const seasonalItem = createListItem(
                    docId,
                    trailerData,
                    details
                  );
                  allSeasonalTrailersList.appendChild(seasonalItem);
                }

                if (trailerData.status === "Empty") {
                  emptyCount++;
                  const emptyListItem = createListItem(
                    docId,
                    trailerData,
                    details
                  );
                  allEmptyTrailersList.appendChild(emptyListItem);
                } else if (trailerData.status === "Salvage") {
                  salvageCount++;
                  const salvageListItem = createListItem(
                    docId,
                    trailerData,
                    details
                  );
                  allSalvageTrailersList.appendChild(salvageListItem);
                } else if (trailerData.status === "Full") {
                  fullCount++;
                }

                if (trailerData.needsFuel) {
                  const needsFuelItem = createListItem(
                    docId,
                    trailerData,
                    details
                  );
                  needsFuelItem.classList.add("needs-fuel");
                  needsFuelList.appendChild(needsFuelItem);
                  needsFuelCount++;
                }
              });

              emptyCountSpan.textContent = `Empty: ${emptyCount}`;
              salvageCountSpan.textContent = `Salvage: ${salvageCount}`;
              fullCountSpan.textContent = `Full: ${fullCount}`;
              needsFuelCountSpan.textContent = needsFuelCount;
              setUIState("enabled");

              const addEditAndDeleteListeners = (listElement) => {
                listElement
                  .querySelectorAll(".edit-button")
                  .forEach((button) => {
                    button.addEventListener("click", (event) => {
                      const docId = event.target.dataset.docId;
                      const trailerData = allTrailers[docId];
                      trailerNumberInput.value = trailerData.trailerNumber;
                      document.querySelector(
                        `input[name="status"][value="${trailerData.status}"]`
                      ).checked = true;
                      needsFuelCheckbox.checked = trailerData.needsFuel;
                      redTaggedCheckbox.checked = trailerData.redTagged;
                      seasonalCheckbox.checked = trailerData.seasonal;
                      palletShuttleCheckbox.checked = trailerData.palletShuttle;
                      northFenceSelect.value = "None";
                      southFenceSelect.value = "None";
                      if (trailerData.comments) {
                        commentContainer.classList.remove("hidden");
                        commentsTextarea.value = trailerData.comments;
                      } else {
                        commentContainer.classList.add("hidden");
                        commentsTextarea.value = "";
                      }
                      editingDocId = docId;
                      addTrailerButton.textContent = "Update";
                      document
                        .querySelectorAll(".trailer-item")
                        .forEach((item) => item.classList.remove("editing"));
                      const itemToEdit = document.querySelector(
                        `[data-doc-id="${docId}"]`
                      );
                      if (itemToEdit) {
                        itemToEdit.classList.add("editing");
                      }
                    });
                  });

                listElement
                  .querySelectorAll(".delete-button")
                  .forEach((button) => {
                    button.addEventListener("click", async (event) => {
                      const docId = event.target.dataset.docId;
                      if (docId) {
                        const docRef = doc(trailersCollectionRef, docId);
                        try {
                          await deleteDoc(docRef);
                          resetForm();
                        } catch (e) {
                          console.error("Error deleting document: ", e);
                          displayError(
                            `Failed to delete trailer: ${e.message}`
                          );
                        }
                      }
                    });
                  });
              };

              addEditAndDeleteListeners(allEmptyTrailersList);
              addEditAndDeleteListeners(allSalvageTrailersList);
              addEditAndDeleteListeners(allPalletShuttleTrailersList);
              addEditAndDeleteListeners(allSeasonalTrailersList);
              addEditAndDeleteListeners(needsFuelList);
            },
            (error) => {
              setUIState("enabled");
              displayError(
                "Failed to load trailers. Please check your Firebase rules and database path."
              );
            }
          );

          addTrailerButton.addEventListener("click", async () => {
            hideError();
            if (!isAuthenticated) {
              displayError(
                "You are not authenticated. Please try refreshing the page."
              );
              return;
            }
            const trailerNumber = trailerNumberInput.value.trim();
            if (!trailerNumber) {
              displayError("Please enter a trailer number.");
              return;
            }

            const status = document.querySelector(
              'input[name="status"]:checked'
            ).value;
            const comments = commentsTextarea.value.trim();
            const trailerData = {
              trailerNumber: trailerNumber,
              status: status,
              needsFuel: needsFuelCheckbox.checked,
              redTagged: redTaggedCheckbox.checked,
              seasonal: seasonalCheckbox.checked,
              palletShuttle: palletShuttleCheckbox.checked,
              comments: comments,
              northFence: northFenceSelect.value,
              southFence: southFenceSelect.value,
              timestamp: new Date(),
            };

            const docIdToUse = editingDocId || trailerNumber;
            const docRef = doc(trailersCollectionRef, docIdToUse);

            try {
              await setDoc(docRef, trailerData);
              lastEnteredWindow.textContent = `${
                editingDocId ? "Updated" : "Recently entered"
              }: ${trailerNumber}`;
              lastEnteredWindow.style.display = "block";
              resetForm();
            } catch (e) {
              console.error("Error writing document: ", e);
              displayError(`Failed to save trailer: ${e.message}`);
            }
          });
        } catch (error) {
          setUIState("disabled");
          displayError(
            `Authentication Failed: ${error.message}. Please check your Firebase configuration.`
          );
        }
      });
    </script>
    <footer>
      <p>Copyright &copy; 2025 Paul Rosenbaum</p>
      <div>
        Questions, Comments,
        <a
          href="mailto:warlord666692000@yahoo.com"
          target="_blank"
          style="color: white"
          ><u>Contact me</u></a
        >
      </div>
    </footer>
  </body>
</html>

